name: Experimental Builds

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - 'scripts/**'
      - 'config.py'
      - 'get-folia-enhanced.py'
      - 'build.py'
      - 'push.py'
      - 'utils.py'
      - 'requirements.txt'
      - 'versions/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'scripts/**'
      - 'config.py'
      - 'get-folia-enhanced.py'
      - 'build.py'
      - 'push.py'
      - 'utils.py'
      - 'requirements.txt'
      - 'versions/**'

permissions:
  contents: read
  packages: write

jobs:
  sync-experimental:
    name: Sync Experimental Versions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          python3 -m venv .venv

      - name: Activate virtual environment and install dependencies
        run: |
          source .venv/bin/activate
          pip install -r requirements.txt
          # Ensure requests is installed for sync_experimental.py
          pip install requests

      - name: Sync experimental versions
        run: |
          source .venv/bin/activate
          python scripts/sync_experimental.py
        env:
          DOCKER_NAMESPACE: ${{ vars.DOCKER_NAMESPACE || 'blackao' }}
          ENABLE_EXPERIMENTAL: true
          EXPERIMENTAL_CHANNEL: experimental
          AUTO_SYNC_EXPERIMENTAL: true

      - name: Check for changes and experimental versions
        id: changes
        run: |
          git_changes=$(git status --porcelain)

          # Check for git changes
          if [ -n "$git_changes" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_files=$(git diff --name-only | wc -l)" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "changed_files=0" >> $GITHUB_OUTPUT
          fi

          # Check if experimental versions exist (always build them)
          if [ -d "versions/1.21.11" ]; then
            echo "has_experimental_versions=true" >> $GITHUB_OUTPUT
            echo "Experimental version 1.21.11 found, will build regardless of sync changes"
          else
            echo "has_experimental_versions=false" >> $GITHUB_OUTPUT
          fi

  build-experimental:
    name: Build Experimental Images
    runs-on: ubuntu-latest
    needs: sync-experimental
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          python3 -m venv .venv

      - name: Activate virtual environment and install dependencies
        run: |
          source .venv/bin/activate
          pip install -r requirements.txt
          # Ensure requests is installed for sync_experimental.py
          pip install requests

      - name: Sync experimental versions
        run: |
          source .venv/bin/activate
          python scripts/sync_experimental.py
        env:
          DOCKER_NAMESPACE: ${{ vars.DOCKER_NAMESPACE || 'blackao' }}
          ENABLE_EXPERIMENTAL: true
          EXPERIMENTAL_CHANNEL: experimental
          AUTO_SYNC_EXPERIMENTAL: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: ${{ vars.DOCKER_USERNAME }}
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build experimental images
        run: |
          source .venv/bin/activate

          # Build ONLY experimental versions with proper tagging
          echo "Building experimental images..."
          for version in "1.21.11"; do
            if [ -d "versions/$version" ]; then
              echo "Building experimental version: $version"
              echo "Current working directory: $(pwd)"
              echo "Docker namespace: $DOCKER_NAMESPACE"
              echo "Contents of versions/$version:"
              ls -la "versions/$version/"

              python build.py "$version"
              BUILD_RESULT=$?

              if [ $BUILD_RESULT -eq 0 ]; then
                echo "✅ Successfully built: $version"
              else
                echo "❌ Failed to build: $version (exit code: $BUILD_RESULT)"
                # Show Docker images for debugging
                echo "Current Docker images:"
                docker images | grep folia || echo "No folia images found"
                exit 1
              fi
            else
              echo "Directory not found: versions/$version"
            fi
          done
        env:
          DOCKER_NAMESPACE: ${{ vars.DOCKER_NAMESPACE || 'blackao' }}

      - name: List built images and verify
        run: |
          echo "=== Docker Images Check ==="
          docker images | grep folia

          echo "=== Verifying Experimental Image ==="
          # Find the actual experimental image built (dynamically detect build number)
          EXPERIMENTAL_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "folia:1.21.11-exp")
          if [ -n "$EXPERIMENTAL_IMAGE" ]; then
            echo "✅ Experimental image found: $EXPERIMENTAL_IMAGE"
            docker inspect "$EXPERIMENTAL_IMAGE" > /dev/null && echo "✅ Image is valid" || echo "❌ Image is corrupted"
          else
            echo "❌ Experimental image NOT found for 1.21.11"
            echo "All available images:"
            docker images
            exit 1
          fi

      - name: Push experimental images
        if: ${{ vars.DOCKER_USERNAME }}
        run: |
          source .venv/bin/activate

          # Push ONLY experimental versions with proper tagging
          echo "=== BEFORE PUSH: Docker Images Status ==="
          docker images | grep folia

          echo "=== Environment Variables ==="
          echo "DOCKER_NAMESPACE: $DOCKER_NAMESPACE"

          echo "=== Verifying image exists before push ==="
          # Find the actual experimental image built (dynamically detect build number)
          EXPERIMENTAL_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "folia:1.21.11-exp" | head -1)
          if [ -n "$EXPERIMENTAL_IMAGE" ]; then
            echo "✅ Image found: $EXPERIMENTAL_IMAGE"
          else
            echo "❌ No experimental image found for 1.21.11"
            echo "Available images:"
            docker images | grep folia || echo "No folia images"
            echo "All Docker images:"
            docker images
            # Try to build manually if image not found
            echo "=== Attempting manual build ==="
            python build.py "1.21.11"
            if [ $? -eq 0 ]; then
              echo "✅ Manual build successful"
              EXPERIMENTAL_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "folia:1.21.11-exp" | head -1)
            else
              echo "❌ Manual build failed"
              exit 1
            fi
          fi

          echo "Pushing experimental images..."
          for version in "1.21.11"; do
            if [ -d "versions/$version" ]; then
              echo "Pushing experimental version: $version"
              python push.py "$version"
              if [ $? -eq 0 ]; then
                echo "✅ Successfully pushed: $version"
              else
                echo "❌ Failed to push: $version"
                echo "Available images:"
                docker images | grep folia
                # Continue with other pushes even if one fails
              fi
            else
              echo "Directory not found: versions/$version"
            fi
          done
        env:
          DOCKER_NAMESPACE: ${{ vars.DOCKER_USERNAME }}

      - name: Create Summary
        run: |
          echo "## Experimental Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Experimental versions processed:** 1.21.11, experimental" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker namespace:** ${{ vars.DOCKER_NAMESPACE || 'blackao' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build status:** Successfully built and pushed experimental versions" >> $GITHUB_STEP_SUMMARY